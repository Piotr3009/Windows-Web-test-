<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Confirming Email - Skylon</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background: linear-gradient(135deg, #0F3124 0%, #1a4d36 100%);
            color: white;
        }
        .container {
            text-align: center;
            padding: 2rem;
        }
        .spinner {
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid #d4af37;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        h1 {
            color: #d4af37;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Confirming Your Email...</h1>
        <div class="spinner"></div>
        <p>Please wait while we verify your email address.</p>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-config.js"></script>

    <script>
        async function handleConfirmation() {
            const container = document.querySelector('.container');
            const h1 = container.querySelector('h1');
            const p = container.querySelector('p');
            const spinner = container.querySelector('.spinner');

            function showSuccess() {
                spinner.style.display = 'none';
                h1.innerText = 'Email Confirmed!';
                h1.style.color = '#4caf50';
                p.innerText = 'Redirecting to home...';
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 2000);
            }

            function showError(msg) {
                spinner.style.display = 'none';
                h1.innerText = 'Verification Issue';
                h1.style.color = '#e74c3c';
                p.innerHTML = `${msg}<br><br>
                <small>Tip: Check if your device clock is synced correctly.</small><br><br>
                <a href="login.html" style="color: gold; text-decoration: underline;">Go to Login</a>`;
            }

            // 1. Nasłuchuj zmian stanu (automatyczne logowanie przez Supabase)
            const { data: { subscription } } = supabaseClient.auth.onAuthStateChange((event, session) => {
                if (event === 'SIGNED_IN' || event === 'USER_UPDATED') {
                    showSuccess();
                }
            });

            // 2. Ręczna weryfikacja
            try {
                // Sprawdź czy użytkownik już jest zalogowany
                const { data: { session } } = await supabaseClient.auth.getSession();
                if (session) {
                    showSuccess();
                    return;
                }

                const urlParams = new URLSearchParams(window.location.search);
                const tokenHash = urlParams.get('token_hash');
                const type = urlParams.get('type');
                const errorCode = urlParams.get('error_code');
                const errorDescription = urlParams.get('error_description');

                // Obsługa błędów z URL
                if (errorCode) throw new Error(errorDescription || 'Link invalid');

                // Nowy Flow (PKCE)
                if (tokenHash && type) {
                    const { error } = await supabaseClient.auth.verifyOtp({
                        token_hash: tokenHash,
                        type: type,
                    });
                    if (error) throw error;
                    return;
                }

                // Stary Flow (Hash)
                const hashParams = new URLSearchParams(window.location.hash.substring(1));
                const accessToken = hashParams.get('access_token');
                
                if (accessToken) {
                    const { error } = await supabaseClient.auth.setSession({
                        access_token: accessToken,
                        refresh_token: hashParams.get('refresh_token')
                    });
                    if (error) throw error;
                    return;
                }

                // Daj czas bibliotece na przetworzenie
                setTimeout(() => {
                    supabaseClient.auth.getSession().then(({ data }) => {
                        if (!data.session && !tokenHash && !accessToken) {
                            showError('No verification token found. Please try logging in.');
                        }
                    });
                }, 3000);

            } catch (error) {
                console.error(error);
                showError(error.message);
            }
        }

        // Uruchom natychmiast
        document.addEventListener('DOMContentLoaded', handleConfirmation);
    </script>
</body>
</html> 